<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>招金 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
    input,select,textarea,option,button{color-scheme:light}
    input,select,textarea{background:#fff!important;color:#0f172a!important;-webkit-text-fill-color:#0f172a;border-color:#cbd5e1}
    select option{background:#fff;color:#0f172a}
    .scroll-y{overflow-y:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>

<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">招</div>
      <div>
        <div class="text-xl font-semibold">招金 線上點餐</div>
        <div class="text-xs text-slate-500">營業時間: 每週二、三、四 16:00-20:00</div>
        <div class="text-xs text-slate-500">每人內用低消50元，禁帶外食</div>
      </div>
    </div>
    <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-8">
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">鍋燒系列</h2>
      <div id="hotpotList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold">呷飽飽系列</h2>
      <div id="fullList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold">喝湯</h2>
      <div id="soupList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold">喝茶</h2>
      <div id="teaList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold">呷甜（甜甜圈）</h2>
      <div id="donutList" class="grid grid-cols-2 gap-4"></div>
    </div>
  </section>

  <aside id="cart"
    class="space-y-6 lg:sticky lg:top-[88px] lg:max-h-[calc(100vh-120px)] lg:overflow-y-auto lg:pr-1"
    style="-webkit-overflow-scrolling: touch;">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\-+\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<!-- 成功視窗（顯示訂單編號 + 同步狀態） -->
<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">訂單編號：</p>
    <p id="displayNoText" class="text-3xl font-extrabold tracking-wider mt-1 mono"></p>
    <p id="syncStatusText" class="text-slate-700 mt-3"></p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 招金</div>
    </div>
  </div>
</footer>

<script>
/* === 設定（請替換為你的 GAS 部署網址 / API Key）=== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwt-mx2kU_oHtKpWkBXiNc0oK4JdEgsKJxuL5r6FZo_RCqilhoxskwkU4iL7KQMgrc3Hg/exec';
const API_KEY  = 'zhaojin';

/* === 工具 & 狀態 === */
const el = s => document.querySelector(s);
const money = n => '$' + Number(n||0).toLocaleString('zh-Hant');
const state = { cart: [] };

/* === 鍋燒主食選項 === */
const HOTPOT_STAPLES = ["意麵","雞絲","冬粉","泡麵","飯"];

/* === 菜單 === */
const MENU = {
  // 鍋燒系列（需選主食）
  hotpot: [
    { id:"hp_orig",   name:"原味鍋燒",     price:80,  requireStaple:true },
    { id:"hp_kimchi", name:"泡菜鍋燒",     price:85,  requireStaple:true },
    { id:"hp_thai",   name:"泰式鍋燒",     price:95,  requireStaple:true },
    { id:"hp_clam",   name:"蛤蜊爆棚鍋燒", price:150, requireStaple:true },
    { id:"hp_shrimp", name:"有夠蝦鍋燒",   price:150, requireStaple:true },
    { id:"hp_purine", name:"通痛風鍋燒",   price:170, requireStaple:true },
  ],
  // 呷飽飽系列
  full: [
    { id:"full_minced_pork_rice", name:"懷舊肉燥飯",   price:35,  noStaple:true },
    { id:"full_rice_noodle",      name:"古味炒米粉",   price:40,  noStaple:true },
    { id:"full_kongrou",          name:"復刻爌肉飯",   price:70,  noStaple:true },
    { id:"full_basil_pork",       name:"台式打拋豬",   price:70,  noStaple:true },
    { id:"full_mixed_chicken",    name:"肉燥雞絲飯",   price:65,  noStaple:true },
    { id:"full_thai_chicken",     name:"泰式雞絲飯",   price:60,  noStaple:true },
    { id:"full_stir_chicken",     name:"香炒雞肉片飯", price:75,  noStaple:true },
    { id:"full_curry",            name:"招金咖喱飯",   price:75,  noStaple:true },
    { id:"full_fried_instant",    name:"炒泡麵",       price:75,  noStaple:true },
    { id:"full_bbq_box",          name:"巴比Ｑ烤肉餐盒", price:85, noStaple:true },
    { id:"full_greenonion_pork",  name:"蔥爆豬肉",     price:85,  noStaple:true },
    { id:"full_pan_chicken_leg",  name:"香煎雞腿",     price:85,  noStaple:true },
    { id:"full_chili_chicken",    name:"椒麻雞腿",     price:85,  noStaple:true },
    { id:"full_pan_pork_chop",    name:"香煎排骨",     price:85,  noStaple:true },
    { id:"full_fried_chicken_lu", name:"炸雞滷肉飯",   price:80,  noStaple:true },
    { id:"full_crispy_chicken",   name:"香酥雞排飯",   price:70,  noStaple:true },
  ],
  // 喝湯
  soup: [
    { id:"soup_egg",      name:"蛋花湯",       price:30, noStaple:true },
    { id:"soup_meatball", name:"貢丸湯",       price:30, noStaple:true },
    { id:"soup_seaweed",  name:"紫菜蛋花湯",   price:40, noStaple:true },
    { id:"soup_clam",     name:"蛤仔湯",       price:40, noStaple:true },
  ],
  // 喝茶
  tea: [
    { id:"tea_black",   name:"紅茶",   price:30, noStaple:true },
    { id:"tea_winter",  name:"冬瓜茶", price:30, noStaple:true },
  ],
  // 呷甜（甜甜圈）
  donut: [
    { id:"donut_orig",     name:"原味",     price:30, noStaple:true },
    { id:"donut_peanut",   name:"花生",     price:40, noStaple:true },
    { id:"donut_straw",    name:"草莓",     price:35, noStaple:true },
    { id:"donut_cheese",   name:"起司",     price:45, noStaple:true },
    { id:"donut_secret",   name:"隱藏版",   price:50, noStaple:true },
    { id:"donut_garlic",   name:"蒜香",     price:35, noStaple:true },
    { id:"donut_choco",    name:"巧克力",   price:35, noStaple:true },
    { id:"donut_milk",     name:"奶酥",     price:35, noStaple:true },
    { id:"donut_mochi",    name:"麻糬",     price:45, noStaple:true },
    { id:"donut_taro",     name:"芋頭",     price:45, noStaple:true },
  ],
};

/* === Render：分類卡片 === */
function renderCategory(list, targetId){
  const root = el(targetId); root.innerHTML='';
  list.forEach(item=>{
    const card=document.createElement('div');
    card.className='card bg-white p-4 flex flex-col';
    card.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div><h3 class="text-lg font-semibold">${item.name}</h3></div>
        <div class="text-right font-semibold mono">${money(item.price)}</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">選擇</button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=> openItemModal(item));
    root.appendChild(card);
  });
}

/* === 選項彈窗（僅鍋燒系列顯示主食，其餘只有數量與備註） === */
let currentItem = null;
function openItemModal(item){
  currentItem = item;
  ensureItemModal();
  document.body.classList.add('overflow-hidden');

  el('#pmTitle').textContent = item.name;

  // 主食：僅鍋燒需要
  const stapleWrap = el('#pmStapleWrap');
  const stapleSel  = el('#pmStaple');
  const needStaple = !!item.requireStaple;
  stapleWrap.style.display = needStaple ? '' : 'none';
  stapleSel.innerHTML='';
  if (needStaple) {
    HOTPOT_STAPLES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stapleSel.appendChild(o); });
  }

  // 備註重設
  el('#pmRemark').value = '';

  // 數量與小計
  const qtyInput = el('#pmQty'); qtyInput.value = 1;
  const updatePmSubtotal = ()=>{
    const qty = Math.max(1, parseInt(qtyInput.value)||1);
    const subtotal = item.price * qty;
    el('#pmSubtotal').textContent = money(subtotal);
  };
  el('#pmDec').onclick = ()=>{ qtyInput.value = Math.max(1, (parseInt(qtyInput.value)||1) - 1); updatePmSubtotal(); };
  el('#pmInc').onclick = ()=>{ qtyInput.value = (parseInt(qtyInput.value)||1) + 1; updatePmSubtotal(); };
  qtyInput.oninput = updatePmSubtotal;
  updatePmSubtotal();

  // 加入購物車
  el('#pmAdd').onclick = ()=>{
    const qty    = Math.max(1, parseInt(qtyInput.value)||1);
    const staple = needStaple ? el('#pmStaple').value : '';
    const remark = (el('#pmRemark')?.value || '').trim();
    addToCart({ item, qty, remark, staple, needStaple });
    closeItemModal();
  };

  el('#itemModal').classList.remove('hidden');
}
function closeItemModal(){
  el('#itemModal')?.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}
function ensureItemModal(){
  if (el('#itemModal')) return;
  const wrap = document.createElement('div');
  wrap.id = 'itemModal';
  wrap.className = 'fixed inset-0 z-40 hidden scroll-y';
  wrap.innerHTML = `
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 min-h-full flex items-start justify-center py-6 px-3">
      <div class="w-full max-w-2xl card bg-white p-6 max-h-[85vh] scroll-y">
        <div class="flex items-start justify-between">
          <div class="min-w-0">
            <h3 id="pmTitle" class="text-xl font-semibold"></h3>
          </div>
          <button id="pmClose" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
        </div>

        <div id="pmStapleWrap" class="mt-4">
          <label class="text-sm text-slate-600">主食</label>
          <select id="pmStaple" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
        </div>

        <div class="mt-5">
          <label class="text-sm text-slate-600">備註（選填）</label>
          <textarea id="pmRemark" rows="2"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
            placeholder=""></textarea>
        </div>

        <div class="mt-5">
          <label class="text-sm text-slate-600">數量</label>
          <div class="mt-1 flex items-center gap-2">
            <button id="pmDec" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
            <input id="pmQty" type="number" min="1" value="1" class="w-20 text-center border border-slate-300 rounded-xl py-2 bg-white text-slate-900" />
            <button id="pmInc" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between">
          <div class="text-lg">小計：<span id="pmSubtotal" class="font-semibold mono">$0</span></div>
          <button id="pmAdd" class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">加入購物車</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
  wrap.querySelector('#pmClose').addEventListener('click', closeItemModal);
}

/* === Cart === */
function addToCart(bundle){ state.cart.push({ type:'meal', ...bundle }); renderCart(); }
function removeCartEntry(index){ state.cart.splice(index,1); renderCart(); }
function cartTotal(){
  return state.cart.reduce((sum,e)=>{
    if(e.type==='meal'){
      return sum + e.item.price*e.qty;
    }
    return sum;
  }, 0);
}
function renderCart(){
  const root=el('#cartItems'); root.innerHTML='';
  if(state.cart.length===0){ root.innerHTML='<div class="text-slate-500">購物車目前沒有商品。</div>'; }
  state.cart.forEach((e, idx)=>{
    const linePrice = e.item.price*e.qty;
    const staplePart = e.needStaple ? ` ｜ 主食：${e.staple||'-'}` : '';
    const div=document.createElement('div');
    div.className='card bg-white p-4';
    div.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-medium">${e.item.name}${staplePart}</div>
          <div class="text-sm text-slate-700 mt-1">備註：${e.remark ? e.remark : '(無)'}</div>
          <div class="text-sm text-slate-600 mt-1">
            數量 ×
            <input type="number" min="1" value="${e.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
          </div>
        </div>
        <div class="shrink-0 text-right">
          <div class="font-semibold mono">${money(linePrice)}</div>
          <button class="remove btn mt-2 px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>
        </div>
      </div>`;
    div.querySelector('.lineQty').addEventListener('input', ev=>{
      let v=parseInt(ev.target.value)||1; if(v<1)v=1; e.qty=v; renderCart();
    });
    div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    root.appendChild(div);
  });
  el('#cartTotal').textContent=money(cartTotal());
}

/* === Apps Script API：enqueue + sync === */
async function apiEnqueue(order){
  const body = { apiKey: API_KEY, action: 'enqueue', order };
  const r = await fetch(ENDPOINT, { method: 'POST', body: JSON.stringify(body) });
  const t = await r.text();
  let d; try { d = JSON.parse(t); } catch { throw new Error('bad_json:' + t.slice(0, 200)); }
  return d; // 期待 { ok:true, orderId, displayNo }
}
async function apiSync(){
  const body = { apiKey: API_KEY, action: 'sync' };
  const r = await fetch(ENDPOINT, { method: 'POST', body: JSON.stringify(body) });
  const t = await r.text();
  let d; try { d = JSON.parse(t); } catch { throw new Error('bad_json:' + t.slice(0, 200)); }
  return d; // 期待 { ok:true, appended, failed }
}

/* === Submit === */
async function onSubmitOrder(e){
  e.preventDefault();
  const btn=e.target.querySelector('button[type="submit"]');
  const setBusy=b=>{ btn.disabled=b; btn.textContent=b?'送出中…':'送出訂單'; };
  const showErr=m=>el('#formError').textContent=m;
  setBusy(true); showErr('');
  try{
    if(state.cart.length===0){ showErr('購物車尚無商品。'); return; }
    const name=el('#customerName').value.trim();
    const phone=el('#customerPhone').value.trim();
    if(!name||!phone){ showErr('請完整填寫姓名與電話。'); return; }

    // 組訂單品項（名稱含主食與備註）
    const items = state.cart.map(e=>{
      const staplePart = e.needStaple ? `｜主食：${e.staple||'-'}` : '';
      const remarkPart = e.remark ? `｜備註：${e.remark}` : '';
      const nameWith   = `${e.item.name}${staplePart}${remarkPart}`;
      return { id:e.item.id, name:nameWith, price:e.item.price, qty:e.qty };
    });
    const subtotal = items.reduce((s,it)=> s + it.price*it.qty, 0);

    const order={
      orderId: crypto.randomUUID(),        // 冪等
      customer:{ name, phone },
      items, subtotal, total:subtotal,
      createdAt:new Date().toISOString(),
      source:'zhaojin-web'
    };

    // Step 1: enqueue（GAS 會回傳 displayNo）
    const enq = await apiEnqueue(order);
    if(!enq.ok){ showErr(`送單失敗：${enq.error||'enqueue_failed'}`); return; }

    // 顯示成功視窗 + 訂單編號（立即可見）
    el('#displayNoText').textContent = enq.displayNo || '';
    el('#syncStatusText').textContent = '正在同步至訂單表中…';
    el('#successModal').classList.remove('hidden');

    // Step 2: 立刻同步（queue -> order）
    const s = await apiSync();
    el('#syncStatusText').textContent = s.ok
      ? '已同步完成。'
      : '同步失敗，系統將於 1 分鐘內自動補同步。';

    // 清空購物車
    state.cart=[]; renderCart();

  }catch(err){
    el('#formError').textContent = '送單失敗：'+err.message;
  }finally{ setBusy(false); }
}

/* === Init === */
document.addEventListener('DOMContentLoaded',()=>{
  el('#year').textContent=new Date().getFullYear();

  // 渲染各分類
  renderCategory(MENU.hotpot,'#hotpotList');
  renderCategory(MENU.full,'#fullList');
  renderCategory(MENU.soup,'#soupList');
  renderCategory(MENU.tea,'#teaList');
  renderCategory(MENU.donut,'#donutList');

  renderCart();
  el('#clearCart').addEventListener('click',()=>{state.cart=[];renderCart();});
  el('#checkoutForm').addEventListener('submit',onSubmitOrder);
  el('#closeSuccess').addEventListener('click',()=>el('#successModal').classList.add('hidden'));
});
</script>
</body>
</html>
